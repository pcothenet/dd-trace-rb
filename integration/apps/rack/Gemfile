require 'datadog/demo_env'

# Hack inspired by https://github.com/Shopify/semian/commit/2225ab140e21f233c933e771ae9347a75595352e
# to get bundler to recompile google-protobuf, rather than trying to use the shipped binaries (which are not available
# for all Ruby versions)
# This is expected to be temporary, since the profiler will replace google-protobuf with libddprof for profile encoding
module BundlerHack
  def __materialize__
    name == 'google-protobuf' ? Bundler.settings.temporary(force_ruby_platform: true) { super } : super
  end
end
Bundler::LazySpecification.prepend(BundlerHack)

source 'https://rubygems.org' do
  gem 'puma'
  gem 'unicorn'
  gem 'rack'
  if RUBY_VERSION < '2.3'
    gem 'redis', '< 4.1.1' # 4.1.1 "claims" to support 2.2 but is actually broken
  else
    gem 'redis'
  end
  if RUBY_VERSION < '2.2'
    gem 'sidekiq', '< 5' # 5.0.3 checks for older Rubies and breaks, but does not declare it on the gemspec :(
  else
    gem 'sidekiq'
  end
  gem 'resque'
  gem 'rake'

  gem 'dogstatsd-ruby'
  gem 'google-protobuf'
  # Choose correct specs for 'ddtrace' demo environment
  gem 'ddtrace', *Datadog::DemoEnv.gem_spec('ddtrace')

  # Development
  gem 'pry-byebug'
  # gem 'pry-stack_explorer', platform: :ruby
  # gem 'rbtrace'
  # gem 'ruby-prof'

  gem 'rspec'
  gem 'rspec-wait'
  gem 'webrick' if RUBY_VERSION >= '2.3' # Older Rubies can just use the built-in version of webrick
end
